!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define("Server",[],r):"object"==typeof exports?exports.Server=r():(e.PostRPC=e.PostRPC||{},e.PostRPC.Server=r())}(this,function(){return function(e){function r(t){if(n[t])return n[t].exports;var o=n[t]={exports:{},id:t,loaded:!1};return e[t].call(o.exports,o,o.exports,r),o.loaded=!0,o.exports}var n={};return r.m=e,r.c=n,r.p="",r(0)}([function(e,exports){"use strict";function r(e){if(Array.isArray(e)){for(var r=0,n=Array(e.length);r<e.length;r++)n[r]=e[r];return n}return Array.from(e)}function n(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=function(){function e(e,r){for(var n=0;n<r.length;n++){var t=r[n];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}return function(r,n,t){return n&&e(r.prototype,n),t&&e(r,t),r}}(),s="2.0",i=-32700,a="Parse error",u="Invalid JSON was received by the server.",l=-32600,d="Invalid request",c="The JSON sent is not a valid request object.",p=-32601,f="Method not found",g="The method does not exist / is not available.",h=-32602,m="Invalid params",v="Invalid method parameter(s).",y=-32603,b="Internal error",k="Internal JSON-RPC error.",j=-32e3,_=function(){function e(r){n(this,e),this._name="PostRPC.Server",this._origin=r,this._registered={},this._logging=!1}return o(e,[{key:"register",value:function(e,r,n,t,o){this.log(["register","method: "+e,"params: "+JSON.stringify(r),"return: "+JSON.stringify(n),"function: function() {}","description: "+o]),this._registered[e]={params:r,return:n,function:t,description:o}}},{key:"unregister",value:function(e){delete this._registered[e]}},{key:"isValid",value:function(e){return!(!(e.jsonrpc===s&&e.method&&"method"in e)||e.method&&0===e.method.lastIndexOf("rpc.",0))}},{key:"isMethodFound",value:function(e){return e.method in this._registered}},{key:"parseErrorResponse",value:function(){return{jsonrpc:s,error:{code:i,message:a,data:u},id:null}}},{key:"invalidRequestResponse",value:function(e){return{jsonrpc:s,error:{code:l,message:d,data:c},id:e.id}}},{key:"methodNotFoundResponse",value:function(e){return{jsonrpc:s,error:{code:p,message:f,data:g},id:e.id}}},{key:"invalidParamsResponse",value:function(e){return{jsonrpc:s,error:{code:h,message:m,data:v},id:e.id}}},{key:"internalErrorResponse",value:function(e){return{jsonrpc:s,error:{code:y,message:b,data:k},id:e.id}}},{key:"success",value:function(e,r){return{jsonrpc:s,result:e,id:r}}},{key:"failure",value:function(e,r,n,t){return{jsonrpc:s,error:{code:e,message:r,data:n},id:t}}},{key:"event",value:function(e,r){return{jsonrpc:s,result:e,event:r,id:null}}},{key:"publish",value:function(e,r){for(var n=["publish: name: "+e+", result: "+JSON.stringify(r)],t=0;t<window.frames.length;t++){var o=window.frames[t];o.postMessage(this.event(r,e),"*")}n.push("("+window.frames.length+") post publish"),this.log(n)}},{key:"start",value:function(){var e=this;window.addEventListener("message",function(r){return e.messageHandler(r)})}},{key:"stop",value:function(){var e=this;window.removeEventListener("message",function(r){return e.messageHandler(r)})}},{key:"mapParams",value:function(e,r){for(var n=[],o=0;o<r.length;o++){var s=r[o];Array.isArray(e)?o<e.length&&n.push(e[o]):null!==e&&"object"===("undefined"==typeof e?"undefined":t(e))&&s[0]in e&&n.push(e[s[0]])}return n}},{key:"messageHandler",value:function(e){var n=e.data,t=["request: "+JSON.stringify(n)];if(this.isValid(n))if(this.isMethodFound(n)){var o=this._registered[n.method],s=o.function,i=this.mapParams(n.params,o.params);if(i.length!==o.params.length)t.push("post invalid params"),e.source.postMessage(this.invalidParamsResponse(n),"*");else{t.push("call: "+n.method+"("+i.join(", ")+")");try{var a=s.apply(void 0,r(i));t.push("return: "+JSON.stringify(a)),t.push("post success"),e.source.postMessage(this.success(a,n.id),"*")}catch(r){t.push("error: name: "+r.name+", message: "+r.message),t.push("post failure"),e.source.postMessage(this.failure(j,r.name,r.message,n.id),"*")}}}else t.push("post method not found"),e.source.postMessage(this.methodNotFoundResponse(n),"*");else t.push("post invalid"),e.source.postMessage(this.invalidRequestResponse(n),"*");this.log(t)}},{key:"logging",value:function(e){this._logging=e}},{key:"log",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"blue";if(this._logging){console.group(this._name);for(var n=0;n<e.length;n++)console.log("%c%s","color:"+r,e[n]);console.groupEnd()}}},{key:"logRegistered",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"blue";if(this._logging){console.group(this._name),console.group("registered");for(var r=this,n=Object.keys(r._registered).map(function(e){return[e,r._registered[e]]}),t=n.sort(function(e,r){return e[0]<r[0]?-1:e[0]>r[0]?1:0}),o=0;o<t.length;o++){var s=[],i=t[o][0],a=t[o][1],u=[],l=[];s.push("/**"),s.push(" * "+a.description);for(var d={Boolean:"true",Null:"null",Undefined:"undefined",Number:"1",String:"str",Object:"{a: 1}",Array:"[1,2]"},c=0;c<a.params.length;c++){var p=a.params[c];s.push(" * @param {"+p[1]+"} "+p[0]),u.push(p[0]),l.push(p[0]+": "+d[p[1]])}s.push(" * @return {"+a.return+"}"),s.push(" */"),s.push(i+"("+u.join(", ")+")"),s.push("client.call('"+i+"', {"+l.join(", ")+"}, func)"),console.groupCollapsed(i);for(var f=0;f<s.length;f++)console.log("%c%s","color:"+e,s[f]);console.groupEnd()}console.groupEnd(),console.groupEnd()}}},{key:"name",get:function(){return this._name}},{key:"origin",get:function(){return this._origin}},{key:"registered",get:function(){return this._registered}}]),e}();exports.default=_,e.exports=exports.default}])});
//# sourceMappingURL=PostRPC.Server.min.js.map